<!doctype html>
<html lang="pl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel testowania - SCBA</title>
    <style>
        body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f7f7f7; }
        header{ padding:12px 16px; background:white; border-bottom:1px solid #e5e5e5; display:flex; justify-content:space-between; align-items:center;}
        .grid{ display:grid; grid-template-columns: 320px 1fr 360px; gap:12px; padding:12px; align-items:start;}
        .card{ background:white; border:1px solid #e5e5e5; border-radius:16px; overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,.04); }
        .card header{ background:#fcfcfc; border-bottom:1px solid #eee; font-weight:600; }
        .section{ padding:8px 12px; border-bottom:1px solid #f1f1f1;}
        .section h4{ margin:8px 0 6px; font-size:14px; text-transform:uppercase; color:#6b7280; }
        .option{ padding:8px 10px; margin:4px 0; border:1px solid #eee; border-radius:10px; cursor:pointer; }
        .option:hover{ background:#f8fafc; }
        .option.active{ background:#eef2ff; border-color:#6366f1; }
        .option.disabled{ opacity:0.5; cursor:not-allowed; }
        .option .back-arrow{ color:#6b7280; margin-right:4px; }
        iframe{ width:100%; height:75vh; border:0; }
        .meta{ font-size:12px; color:#6b7280; padding:8px 12px;}
        .kv{ display:flex; justify-content:space-between; padding:6px 12px; border-bottom:1px dashed #eee; font-size:14px;}
        .big{ font-size:28px; font-weight:700; }
        .muted{ color:#6b7280; font-size:12px; }
        #menuCard{ max-height: calc(100vh - 100px); overflow:auto; }
        .option .label{ display:inline-block; }
        .option .hint{ display:block; font-size:12px; color:#6b7280; margin-top:2px; }
        .menu-title{ padding:10px 12px; background:#2c3547; color:white; font-weight:600; text-transform:uppercase; font-size:13px; }
        .interaction-header{ text-align:center; }
        .data-header{ text-align:center; }
        .pressure-group{ background:#f8fafc; border-radius:8px; padding:8px; margin:8px; }
        .pressure-label{ font-size:11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px; }
        .status-indicator{ display:inline-block; width:8px; height:8px; border-radius:50%; background:#10b981; margin-right:4px; }
    </style>
</head>
<body>
<header>
    <div><strong>Poszerzona struktura programu - Menu testowania</strong></div>
    <div id="user-meta" class="muted"></div>
</header>
<div class="grid">
    <!-- LEFT: MENU -->
    <div class="card" id="menuCard">
        <div class="menu-title">MENU</div>
        <div id="menuRoot"></div>
        <div class="meta" id="deviceMeta"></div>
        <div class="meta" id="selectionSummary"></div>
    </div>

    <!-- CENTER: INTERACTION -->
    <div class="card">
        <header class="section interaction-header">INTERACTION</header>
        <iframe id="viewer" src="./pages/1.html"></iframe>
        <div class="meta" id="helpBox">Informacje o problemach, wskazówkach dla użytkownika</div>
    </div>

    <!-- RIGHT: DATA SENSORS -->
    <div class="card">
        <header class="section data-header">DATA SENSORS</header>
        <div class="pressure-group">
            <div class="pressure-label">PRESSURE</div>
            <div class="kv">
                <span>Low</span>
                <span class="big" id="valLow">10</span>
            </div>
            <div class="kv">
                <span>Medium</span>
                <span class="big" id="valMid">20</span>
            </div>
            <div class="kv">
                <span>High</span>
                <span class="big" id="valHigh">30</span>
            </div>
        </div>
        <div class="section">
            <div class="kv">
                <span class="muted">Device Name, Type</span>
                <span id="deviceInfo">CONNECT 500</span>
            </div>
            <div class="kv">
                <span class="muted">IP NO (DOMAIN) : PORT</span>
                <span id="endpointMeta">192.168.1.10:8080</span>
            </div>
            <div class="kv">
                <span class="muted">Device Status</span>
                <span><span class="status-indicator"></span><span id="status">System Ready</span></span>
            </div>
        </div>
    </div>
</div>

<div style="padding:8px 20px; background:#f1f1f1; display:flex; justify-content:space-between; align-items:center; font-size:12px;">
    <div>
        <span>role : <strong id="userRole">username</strong></span> |
        <span>Date - Time: <strong id="dateTime">12.12.2025 - 12:05:01</strong></span>
    </div>
    <div>
        <span>informacje użytkownika</span> |
        <span>Help / Follow Me</span>
    </div>
</div>

<script>
    const API = (window.API_URL || "") || (location.origin.replace(":3000",":5000"));
    let currentMenu = 'system_menu';
    let currentUser = null;
    let menuData = null;

    async function loadConfig(){
        const res = await fetch(API + '/api/config');
        return res.json();
    }

    async function loadMenu(){
        const res = await fetch(API + '/api/menu');
        menuData = await res.json();
        return menuData;
    }

    function renderMenu(data, menuId = 'system_menu'){
        const root = document.getElementById('menuRoot');
        const iframe = document.getElementById('viewer');
        root.innerHTML = '';

        if(!data.menu_structure) return;

        // Find current menu section
        const menuSection = data.menu_structure.find(m => m.id === menuId);
        if(!menuSection) return;

        // Add menu title
        const titleDiv = document.createElement('div');
        titleDiv.className = 'section';
        titleDiv.innerHTML = `<h4>${menuSection.name}</h4>`;
        root.appendChild(titleDiv);

        // Add menu items
        menuSection.items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'option';

            // Check if disabled
            if(menuSection.requires_login && !currentUser){
                div.classList.add('disabled');
            }

            // Add back arrow for navigation items
            let labelHTML = '';
            if(item.name.includes('...')){
                labelHTML = `<span class="back-arrow">←</span> ${item.name}`;
            } else {
                labelHTML = item.name;
            }

            div.innerHTML = `<span class="label">${labelHTML}</span>`;
            if(item.description){
                div.innerHTML += `<span class="hint">${item.description}</span>`;
            }

            div.onclick = () => {
                if(div.classList.contains('disabled')) return;

                // Handle navigation
                if(item.action === 'back_to_user_menu'){
                    renderMenu(menuData, 'user_menu');
                    return;
                }
                if(item.action === 'back_to_menu'){
                    renderMenu(menuData, 'system_menu');
                    return;
                }

                // Mark active
                root.querySelectorAll('.option').forEach(n=>n.classList.remove('active'));
                div.classList.add('active');

                // Load page
                if(item.page){
                    iframe.src = './pages/' + item.page + '.html';
                }

                // Update help text
                document.getElementById('helpBox').textContent =
                    item.description || `${menuSection.name} → ${item.name}`;

                // Handle special menu transitions
                if(item.key === 'test_menu'){
                    renderMenu(menuData, 'test_menu');
                } else if(item.key === 'service_menu'){
                    renderMenu(menuData, 'service_menu');
                } else if(item.key === 'autodiagnostic'){
                    renderMenu(menuData, 'autodiagnostic_menu');
                }

                // Handle actions
                if(item.action){
                    handleAction(item.action);
                }
            };

            root.appendChild(div);
        });

        // Auto-select first non-disabled option
        const firstOpt = root.querySelector('.option:not(.disabled)');
        if(firstOpt && idx === 0) firstOpt.click();
    }

    function handleAction(action){
        switch(action){
            case 'logout_user':
                currentUser = null;
                document.getElementById('userRole').textContent = '- - -';
                renderMenu(menuData, 'login_menu');
                break;
            case 'system_calibration':
                document.getElementById('status').textContent = 'System calibration in Progress ...';
                setTimeout(() => {
                    document.getElementById('status').textContent = 'System Ready';
                    renderMenu(menuData, 'login_menu');
                }, 3000);
                break;
        }
    }

    async function tick(){
        try{
            const res = await fetch(API + '/api/sensors');
            const d = await res.json();
            document.getElementById('valLow').textContent = d.values.low;
            document.getElementById('valMid').textContent = d.values.mid;
            document.getElementById('valHigh').textContent = d.values.high;
            document.getElementById('deviceInfo').textContent = `${d.device.name}, ${d.device.type}`;
            document.getElementById('endpointMeta').textContent = d.device.endpoint;
            document.getElementById('status').textContent = d.status || 'System Ready';
        }catch(e){
            document.getElementById('status').textContent = 'Brak połączenia z API';
        }
    }

    function updateDateTime(){
        const now = new Date();
        document.getElementById('dateTime').textContent =
            now.toLocaleDateString('pl-PL') + ' - ' + now.toLocaleTimeString('pl-PL');
    }

    // Listen for messages from iframes
    window.addEventListener('message', (e) => {
        if(e.data.type === 'login' && e.data.success){
            currentUser = { username: 'r.arendt', role: 'OPERATOR' };
            document.getElementById('userRole').textContent = currentUser.username;
            renderMenu(menuData, 'user_menu');
        }
        if(e.data.type === 'navigate'){
            document.getElementById('viewer').src = './pages/' + e.data.page + '.html';
        }
    });

    async function boot(){
        try{
            const cfg = await loadConfig();
            document.getElementById('user-meta').textContent = new Date().toLocaleString();
            document.getElementById('deviceMeta').textContent = `role: operator | ${cfg.DEVICE_NAME}`;
            const menu = await loadMenu();
            renderMenu(menu);
            tick();
            setInterval(tick, 1000);
            setInterval(updateDateTime, 1000);
        }catch(e){
            console.error('Boot error:', e);
        }
    }

    boot();
</script>
</body>
</html>
